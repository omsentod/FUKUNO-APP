
Deafult 

<?php

namespace App\Exports;

use App\Models\Task;
use Maatwebsite\Excel\Concerns\FromCollection;
use Maatwebsite\Excel\Concerns\WithHeadings;
use Maatwebsite\Excel\Concerns\WithMapping;
use Carbon\Carbon;

class TasksExport implements FromCollection, WithHeadings, WithMapping
{
    protected $ids;

    // Terima ID yang dipilih dari Controller
    public function __construct($ids)
    {
        $this->ids = $ids;
    }

    // Ambil data berdasarkan ID yang dipilih
    public function collection()
    {
        return Task::with('user', 'status', 'taskPekerjaans.checklists', 'mockups')
                   ->whereIn('id', $this->ids)
                   ->orderBy('created_at', 'desc')
                   ->get();
    }

    // Judul Kolom di Excel (Sesuai Request Anda)
    public function headings(): array
    {
        return [
            'No. PO',
            'Tasks Title',
            'Jumlah',
            'Line Pekerjaan',
            'Urgent',
            'Status',
            'Time Left',
            'Klien',
            'Progress (%)'
        ];
    }

    // Isi Data per Baris
    public function map($task): array
    {
        // 1. Ambil Line Pekerjaan
        $line = $task->taskPekerjaans->first();
        
        // 2. Hitung Progress
        $checklists = $line ? $line->checklists : collect();
        $total = $checklists->count();
        $completed = $checklists->where('is_completed', true)->count();
        $percentage = ($total > 0) ? round(($completed / $total) * 100) : 0;

        // 3. Hitung Time Left (Sama seperti logika Blade)
        $timeLeftString = '-';
        $isDone = ($task->status->name == 'Done and Ready' || $task->status->name == 'Delivered' || $percentage == 100);

        if ($isDone) {
            $timeLeftString = ($task->status->name == 'Delivered') ? 'Terkirim' : 'Selesai';
        } elseif ($line && $line->deadline) {
            $deadline = Carbon::parse($line->deadline);
            $timeLeftString = $deadline->diffForHumans();
            // Terjemahkan sedikit agar rapi di Excel
            $timeLeftString = str_replace(['from now', 'ago'], ['lagi', 'lalu'], $timeLeftString);
        }

        return [
            $task->no_invoice,
            $task->judul,
            $task->total_jumlah,
            $line ? $line->nama_pekerjaan : 'N/A',
            $task->urgensi,
            $task->status->name,
            $timeLeftString, // Hasil hitungan Time Left
            $task->nama_pelanggan,
            $percentage . '%' // Progress
        ];
    }
}





SATU Mockup

<?php

namespace App\Exports;

use App\Models\Task;
use Maatwebsite\Excel\Concerns\FromCollection;
use Maatwebsite\Excel\Concerns\WithHeadings;
use Maatwebsite\Excel\Concerns\WithMapping;
use Maatwebsite\Excel\Concerns\WithDrawings;
use Maatwebsite\Excel\Concerns\WithEvents; // 1. Import Event
use Maatwebsite\Excel\Events\AfterSheet;   // 2. Import AfterSheet
use PhpOffice\PhpSpreadsheet\Worksheet\Drawing;
use PhpOffice\PhpSpreadsheet\Style\Alignment; // Untuk rata tengah
use Carbon\Carbon;

class TasksExport implements FromCollection, WithHeadings, WithMapping, WithDrawings, WithEvents
{
    protected $ids;
    protected $tasks;

    public function __construct($ids)
    {
        $this->ids = $ids;
        $this->tasks = Task::with('user', 'status', 'taskPekerjaans.checklists', 'mockups')
                   ->whereIn('id', $this->ids)
                   ->orderBy('created_at', 'desc')
                   ->get();
    }

    public function collection()
    {
        return $this->tasks;
    }

    public function headings(): array
    {
        return [
            'No. PO', 'Tasks Title', 'Jumlah', 'Line Pekerjaan', 
            'Urgent', 'Status', 'Time Left', 'Mockup', 'Klien', 'Progress (%)'
        ];
    }

    public function map($task): array
    {
        // ... (Isi fungsi map SAMA PERSIS seperti sebelumnya) ...
        // Saya singkat agar tidak kepanjangan, salin logika map Anda yang tadi di sini
        $line = $task->taskPekerjaans->first();
        $checklists = $line ? $line->checklists : collect();
        $completed = $checklists->where('is_completed', true)->count();
        $total = $checklists->count();
        $percentage = ($total > 0) ? round(($completed / $total) * 100) : 0;
        
        $timeLeftString = '-';
        $isDone = ($task->status->name == 'Done and Ready' || $task->status->name == 'Delivered' || $percentage == 100);
        if ($isDone) {
            $timeLeftString = ($task->status->name == 'Delivered') ? 'Terkirim' : 'Selesai';
        } elseif ($line && $line->deadline) {
            $timeLeftString = Carbon::parse($line->deadline)->diffForHumans();
        }

        return [
            $task->no_invoice, $task->judul, $task->total_jumlah,
            $line ? $line->nama_pekerjaan : 'N/A',
            $task->urgensi, $task->status->name, $timeLeftString,
            '', // Kosong untuk tempat gambar
            $task->nama_pelanggan, $percentage . '%'
        ];
    }

    public function drawings()
    {
        $drawings = [];
        foreach ($this->tasks as $index => $task) {
            $mockup = $task->mockups->first();
            if ($mockup) {
                $imagePath = storage_path('app/public/' . $mockup->file_path);
                if (file_exists($imagePath)) {
                    $drawing = new Drawing();
                    $drawing->setName('Mockup');
                    $drawing->setPath($imagePath);
                    $drawing->setHeight(50); // Tinggi Gambar 50px
                    $drawing->setCoordinates('H' . ($index + 2));
                    
                    // Offset agar gambar ada di tengah kotak (opsional)
                    $drawing->setOffsetX(5); 
                    $drawing->setOffsetY(5); 
                    
                    $drawings[] = $drawing;
                }
            }
        }
        return $drawings;
    }

    /**
     * ▼▼▼ LOGIKA BARU: ATUR TINGGI BARIS AGAR GAMBAR MUAT ▼▼▼
     */
    public function registerEvents(): array
    {
        return [
            AfterSheet::class => function(AfterSheet $event) {
                $sheet = $event->sheet->getDelegate();
                
                // Hitung total baris data
                $rowCount = $this->tasks->count() + 1; // +1 Header

                // Loop setiap baris data
                for ($i = 2; $i <= $rowCount; $i++) {
                    // Set tinggi baris jadi 60px (sedikit lebih besar dari gambar 50px)
                    // Supaya gambar punya ruang napas
                    $sheet->getRowDimension($i)->setRowHeight(60); 
                }

                // Atur Lebar Kolom Mockup (H) biar lega
                $sheet->getColumnDimension('H')->setWidth(12);

                // (Opsional) Rata Tengah Vertikal Semua Tulisan
                $sheet->getStyle('A1:J' . $rowCount)
                      ->getAlignment()
                      ->setVertical(Alignment::VERTICAL_CENTER);
            },
        ];
    }
}



